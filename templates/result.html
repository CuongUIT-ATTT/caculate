<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>K·∫øt qu·∫£ t√≠nh to√°n</title>
    <style>
      :root {
        --bg: #ffffff;
        --bg-alt: #f8fafc;
        --fg: #111827;
        --muted: #6b7280;
        --border: #e5e7eb;
        --accent: #2563eb; /* blue-600 */
        --accent-hover: #1d4ed8; /* blue-700 */
        --positive: #16a34a; /* green-600 */
        --warning: #f59e0b; /* amber-500 */
        --danger: #dc2626; /* red-600 */
      }
      /* Dark theme variables */
      body[data-theme="dark"] {
        --bg: #0b1220;
        --bg-alt: #0f172a;
        --fg: #e5e7eb;
        --muted: #94a3b8;
        --border: #1f2937;
        --accent: #60a5fa;
        --accent-hover: #3b82f6;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial,
          sans-serif;
        margin: 0;
        background: var(--bg);
        color: var(--fg);
      }
      .wrap {
        padding: 24px;
      }
      .card {
        max-width: 1100px;
        margin: 0 auto;
        padding: 24px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #fff;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
      }
      body[data-theme="dark"] .card {
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        background: #0f172a;
      }
      h1 {
        margin-top: 0;
        font-size: 22px;
      }
      .btn {
        display: inline-block;
        margin-top: 12px;
        padding: 10px 14px;
        background: linear-gradient(135deg, var(--accent), var(--accent-hover));
        color: #fff;
        border-radius: 9999px;
        text-decoration: none;
        box-shadow: 0 4px 10px rgba(37, 99, 235, 0.25);
        transition: transform 0.08s ease-out, box-shadow 0.2s ease;
      }
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 14px rgba(29, 78, 216, 0.3);
      }
      .accent-bar {
        height: 4px;
        background: var(--accent);
        border-radius: 9999px;
        margin: 6px 0 16px;
      }
      .summary {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
        list-style: none;
        padding: 0;
      }
      .summary li {
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 10px;
      }
      .table-wrap {
        width: 100%;
        overflow-x: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
        min-width: 680px;
      }
      th,
      td {
        border: 1px solid var(--border);
        padding: 8px;
        text-align: left;
      }
      th {
        background: var(--bg-alt);
      }
      tbody tr:nth-child(odd) {
        background: #fbfdff;
      }
      tbody tr:hover {
        background: #f3f4f6;
      }
      /* Dark mode: ensure white cells use dark text for contrast */
      body[data-theme="dark"] table tbody tr:nth-child(odd) {
        background: #fbfdff;
        color: #111827;
      }
      body[data-theme="dark"] table tbody tr:nth-child(odd) td.amount {
        color: #111827;
      }
      .table-wrap table.sticky thead th {
        position: sticky;
        top: 0;
        z-index: 2;
      }
      .amount {
        text-align: right;
      }
      .search-bar {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 8px 0 4px;
      }
      .search-bar input {
        flex: 1;
        padding: 10px 12px;
        border: 1px solid #cbd5e1;
        border-radius: 10px;
        font-size: 16px;
      }
      /* Dark mode: inputs/selects stay white with black text for readability */
      body[data-theme="dark"] input,
      body[data-theme="dark"] select {
        background: #ffffff;
        color: #111827;
        border-color: #cbd5e1;
      }
      .note {
        color: var(--muted);
        font-size: 14px;
      }
      @media (max-width: 640px) {
        .wrap {
          padding: 16px;
        }
        .card {
          padding: 16px;
        }
        h1 {
          font-size: 20px;
        }
        .summary {
          grid-template-columns: 1fr;
        }
        th,
        td {
          padding: 6px;
          font-size: 14px;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <div
          style="
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
          "
        >
          <h1 style="margin: 0">
            T·ªïng k·∫øt cho {{ totals.person }} - {{ totals.base_name }}
          </h1>
          <button
            id="themeToggle"
            class="btn"
            type="button"
            title="Chuy·ªÉn ch·∫ø ƒë·ªô s√°ng/t·ªëi"
          >
            üåô/‚òÄÔ∏è
          </button>
        </div>
        <div class="accent-bar"></div>

        <h2>T·ªïng c·ªông</h2>
        <ul class="summary">
          <li>
            Ph·∫ßn li√™n quan: <strong>{{ totals.total_shared }}</strong> VND
          </li>
          <li>
            ƒê√£ tr·∫£: <strong>{{ totals.total_paid_by_person }}</strong> VND
          </li>
          <li>C√≤n n·ª£: <strong>{{ totals.remaining }}</strong> VND</li>
          <li>Cutoff: {{ totals.cutoff or '‚Äî' }}</li>
        </ul>

        <h3>T·∫£i xu·ªëng k·∫øt qu·∫£</h3>
        <p>
          {% for fmt in available_exports %}
          <a
            class="btn btn-export"
            data-fmt="{{ fmt }}"
            href="/export/{{ fmt }}?file={{ params.file }}&uploaded={{ params.uploaded }}&person={{ params.person }}&paid_on={{ params.paid_on }}&start={{ params.start }}"
            >T·∫£i {{ fmt|upper }}</a
          >
          {% endfor %}
        </p>
        <p>
          <button id="shareBtn" class="btn" type="button">üîó Copy link chia s·∫ª</button>
        </p>
        <h3>T√¨m ki·∫øm giao d·ªãch</h3>
        <div class="search-bar">
          <input
            id="searchBox"
            type="search"
            placeholder="Nh·∫≠p t·ª´ kho√° ƒë·ªÉ l·ªçc trong b·∫£ng‚Ä¶"
          />
          <span id="searchCount" class="note"></span>
        </div>
        <div
          class="row"
          style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px"
        >
          <div>
            <label for="start_date">T·ª´ ng√†y</label>
            <input id="start_date" type="date" />
          </div>
          <div>
            <label for="end_date">ƒê·∫øn ng√†y</label>
            <input id="end_date" type="date" />
          </div>
          <div>
            <label for="category">Danh m·ª•c</label>
            <select id="category">
              <option value="">-- T·∫•t c·∫£ --</option>
              {% for c in categories %}
              <option value="{{ c }}">{{ c }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <h2>Chi ti·∫øt ph·∫ßn li√™n quan</h2>
        <div class="table-wrap">
          <table id="sharedTable" class="sticky">
            <thead>
              <tr>
                <th data-type="date">Ng√†y</th>
                <th data-type="string">Danh m·ª•c</th>
                <th data-type="string">Ghi ch√∫</th>
                <th class="amount" data-type="number">Amount</th>
                <th class="amount" data-type="number">Share</th>
                <th>L√Ω do</th>
              </tr>
            </thead>
            <tbody>
              {% for r in shared_rows %}
              <tr>
                <td>{{ r.date }}</td>
                <td>{{ r.category }}</td>
                <td>{{ r.note }}</td>
                <td class="amount">{{ r.amount }}</td>
                <td class="amount">{{ r.share }}</td>
                <td>{{ r.reason }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <h2>Kho·∫£n ƒë√£ tr·∫£ (√°p d·ª•ng)</h2>
        <div class="table-wrap">
          <table id="appliedTable" class="sticky">
            <thead>
              <tr>
                <th data-type="date">Ng√†y</th>
                <th>Danh m·ª•c</th>
                <th>Ghi ch√∫</th>
                <th class="amount" data-type="number">Amount</th>
              </tr>
            </thead>
            <tbody>
              {% for r in applied_payments %}
              <tr>
                <td>{{ r.date }}</td>
                <td>{{ r.category }}</td>
                <td>{{ r.note }}</td>
                <td class="amount">{{ r.amount }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <h2>Kho·∫£n kh√¥ng √°p d·ª•ng (tr∆∞·ªõc cutoff)</h2>
        <div class="table-wrap">
          <table id="unappliedTable" class="sticky">
            <thead>
              <tr>
                <th data-type="date">Ng√†y</th>
                <th>Danh m·ª•c</th>
                <th>Ghi ch√∫</th>
                <th class="amount" data-type="number">Amount</th>
              </tr>
            </thead>
            <tbody>
              {% for r in unapplied_payments %}
              <tr>
                <td>{{ r.date }}</td>
                <td>{{ r.category }}</td>
                <td>{{ r.note }}</td>
                <td class="amount">{{ r.amount }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <p><a class="btn" href="/">‚Ü©Ô∏è Quay l·∫°i</a></p>
      </div>
    </div>
    <script>
      (function () {
        // Build export links with current filters
        const baseParams = {
          file: "{{ params.file }}",
          uploaded: "{{ params.uploaded }}",
          person: "{{ params.person }}",
          paid_on: "{{ params.paid_on }}",
          start: "{{ params.start }}",
          q: "{{ params.q or '' }}",
          start_date: "{{ params.start_date or '' }}",
          end_date: "{{ params.end_date or '' }}",
          category: "{{ params.category or '' }}",
        };
        const exportBtns = Array.from(document.querySelectorAll(".btn-export"));
        const qEl = document.getElementById("searchBox");
        const sEl = document.getElementById("start_date");
        const eEl = document.getElementById("end_date");
        const catEl = document.getElementById("category");
        function updateExportLinks() {
          exportBtns.forEach((a) => {
            const fmt = a.getAttribute("data-fmt");
            const params = new URLSearchParams(baseParams);
            if (qEl && qEl.value) params.set("q", qEl.value);
            if (sEl && sEl.value) params.set("start_date", sEl.value);
            if (eEl && eEl.value) params.set("end_date", eEl.value);
            if (catEl && catEl.value) params.set("category", catEl.value);
            a.href = "/export/" + fmt + "?" + params.toString();
          });
        }
        // Prefill filters from URL params
        if (qEl && baseParams.q) qEl.value = baseParams.q;
        if (sEl && baseParams.start_date) sEl.value = baseParams.start_date;
        if (eEl && baseParams.end_date) eEl.value = baseParams.end_date;
        if (catEl && baseParams.category) catEl.value = baseParams.category;
        updateExportLinks();
        ["input", "change"].forEach((evt) => {
          if (qEl) qEl.addEventListener(evt, updateExportLinks);
          if (sEl) sEl.addEventListener(evt, updateExportLinks);
          if (eEl) eEl.addEventListener(evt, updateExportLinks);
          if (catEl) catEl.addEventListener(evt, updateExportLinks);
        });
        // Theme toggle
        const body = document.body;
        const themeKey = "thu-chi-theme";
        const saved = localStorage.getItem(themeKey);
        if (saved) {
          body.setAttribute("data-theme", saved);
        } else {
          body.setAttribute("data-theme", "light");
        }
        const toggleBtn = document.getElementById("themeToggle");
        if (toggleBtn) {
          toggleBtn.addEventListener("click", function () {
            const cur =
              body.getAttribute("data-theme") === "dark" ? "light" : "dark";
            body.setAttribute("data-theme", cur);
            localStorage.setItem(themeKey, cur);
          });
        }
        const q = document.getElementById("searchBox");
        const countEl = document.getElementById("searchCount");
        const tables = ["sharedTable", "appliedTable", "unappliedTable"]
          .map((id) => document.getElementById(id))
          .filter(Boolean);
        function filter() {
          const term = (q.value || "").toLowerCase();
          const sd = sEl && sEl.value ? new Date(sEl.value) : null;
          const ed = eEl && eEl.value ? new Date(eEl.value) : null;
          const cat = (catEl && catEl.value) ? catEl.value.toLowerCase() : "";
          let visible = 0;
          tables.forEach((tbl) => {
            const body = tbl.tBodies[0];
            if (!body) return;
            const rows = body.rows;
            for (let i = 0; i < rows.length; i++) {
              const cells = rows[i].cells;
              let match = term === "";
              if (!match) {
                for (let j = 0; j < cells.length; j++) {
                  const txt = (cells[j].textContent || "").toLowerCase();
                  if (txt.includes(term)) {
                    match = true;
                    break;
                  }
                }
              }
              // Category filter (2nd column index 1)
              if (match && cat) {
                const rowCat = (cells[1]?.textContent || "").toLowerCase();
                if (rowCat !== cat) match = false;
              }
              // Date range filter (1st column index 0)
              if (match && (sd || ed)) {
                const dtxt = (cells[0]?.textContent || "");
                const d = new Date(dtxt);
                if (sd && (isNaN(d) || d < sd)) match = false;
                if (ed && (isNaN(d) || d > ed)) match = false;
              }
              rows[i].style.display = match ? "" : "none";
              if (match) visible++;
            }
          });
          if (countEl) {
            countEl.textContent = term ? `K·∫øt qu·∫£ hi·ªÉn th·ªã: ${visible}` : "";
          }
        }
        if (q) q.addEventListener("input", filter);
        if (sEl) sEl.addEventListener("change", filter);
        if (eEl) eEl.addEventListener("change", filter);
        if (catEl) catEl.addEventListener("change", filter);
        // Apply initial filter if values preset by URL
        filter();

        // Copy remaining button
        const copyBtn = document.createElement("button");
        copyBtn.textContent = "üìã Copy s·ªë c√≤n n·ª£";
        copyBtn.className = "btn";
        const summaryList = document.querySelector(".summary");
        if (summaryList) {
          summaryList.parentNode.insertBefore(copyBtn, summaryList.nextSibling);
          copyBtn.addEventListener("click", () => {
            const remainingItem = Array.from(summaryList.children).find((li) =>
              li.textContent.includes("C√≤n n·ª£")
            );
            const text = remainingItem
              ? remainingItem.textContent.replace(/[^0-9.]/g, "").trim()
              : "";
            const value = text || "{{ totals.remaining }}";
            const done = () => {
              copyBtn.textContent = "‚úÖ ƒê√£ copy";
              setTimeout(
                () => (copyBtn.textContent = "üìã Copy s·ªë c√≤n n·ª£"),
                1500
              );
            };
            if (navigator.clipboard && window.isSecureContext) {
              navigator.clipboard
                .writeText(value)
                .then(done)
                .catch(() => fallbackCopy(value, done));
            } else {
              fallbackCopy(value, done);
            }
          });
        }

        function fallbackCopy(value, cb) {
          try {
            const ta = document.createElement("textarea");
            ta.value = value;
            ta.setAttribute("readonly", "");
            ta.style.position = "absolute";
            ta.style.left = "-9999px";
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
            cb && cb();
          } catch (e) {
            alert("Kh√¥ng th·ªÉ copy. Gi√° tr·ªã: " + value);
          }
        }

        // Share link button
        const shareBtn = document.getElementById("shareBtn");
        if (shareBtn) {
          shareBtn.addEventListener("click", () => {
            const params = new URLSearchParams(baseParams);
            if (qEl && qEl.value) params.set("q", qEl.value);
            if (sEl && sEl.value) params.set("start_date", sEl.value);
            if (eEl && eEl.value) params.set("end_date", eEl.value);
            if (catEl && catEl.value) params.set("category", catEl.value);
            const url = `${location.origin}/result?${params.toString()}`;
            const done = () => {
              shareBtn.textContent = "‚úÖ ƒê√£ copy link";
              setTimeout(() => (shareBtn.textContent = "üîó Copy link chia s·∫ª"), 1500);
            };
            if (navigator.clipboard && window.isSecureContext) {
              navigator.clipboard.writeText(url).then(done).catch(() => fallbackCopy(url, done));
            } else {
              fallbackCopy(url, done);
            }
          });
        }

        // Column sorting
        function parseVal(type, text) {
          const t = (text || "").trim();
          if (type === "number") {
            const n = Number(t.replace(/[^0-9.-]/g, ""));
            return isNaN(n) ? 0 : n;
          }
          if (type === "date") {
            const d = new Date(t);
            return d.getTime() || 0;
          }
          return t.toLowerCase();
        }
        function makeSortable(tbl) {
          const thead = tbl.tHead;
          if (!thead) return;
          const headers = thead.rows[0].cells;
          for (let i = 0; i < headers.length; i++) {
            const th = headers[i];
            th.style.cursor = "pointer";
            th.title = "Nh·∫•n ƒë·ªÉ s·∫Øp x·∫øp";
            let asc = true;
            th.addEventListener("click", function () {
              const type = th.getAttribute("data-type") || "string";
              const rows = Array.from(tbl.tBodies[0].rows);
              rows.sort((a, b) => {
                const av = parseVal(type, a.cells[i]?.textContent);
                const bv = parseVal(type, b.cells[i]?.textContent);
                if (av < bv) return asc ? -1 : 1;
                if (av > bv) return asc ? 1 : -1;
                return 0;
              });
              asc = !asc;
              const frag = document.createDocumentFragment();
              rows.forEach((r) => frag.appendChild(r));
              tbl.tBodies[0].appendChild(frag);
            });
          }
        }
        tables.forEach(makeSortable);
      })();
    </script>
  </body>
</html>
